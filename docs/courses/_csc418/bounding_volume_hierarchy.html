---
title: Bounding Volume Hierarchy
order: 5
---
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1>Object Partitioning vs. Space Partitioning Schemes</h1>
<p>Object partitioning schemes are to bound objects into a big collection (box, sphere, convex hull) so that we can quickly query the data structure. The space can be shared within multiple bounding.</p>
<p>Space partitioning schemes are to divide the space into subspaces.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1>Types of Bounding boxes</h1>
<p><img src="assets/bvh.png" alt=""></p>
<h2>Axis Aligned Bounding Box</h2>
<p>Consider a 2D example, an AABB is defined by 4 lines 
$$x = x_{min}, x = x_{max}, y=y_{min}, y=y_{max}$$
where the point is within the bounding box if<br>
$$(x, y) \in [x_{min}, x_{max}]\times[y_{min}, y_{max}]$$</p>
<p>Easy to build, but waste a lot of areas</p>
<h2>Sphere</h2>
<p>For a group of objects $A_1,...,A_n$, let the 
$$c = \sum_{i=1}^n \frac{A_i}{n}, r = \max\{\|A_i - c\|\}$$
However, note that intersecting with a sphere involves solving a quadratic equation hence more computations. Also, it wastes a lot of areas</p>
<h2>Oriented Bounding box</h2>
<p>For a group of objects $A_1,..., A_n$, do PCA so that we can take the first 2 largest principal components, and make it our axis.</p>
<p>Little area wasted, but computations for interactions and constructions</p>
<h2>Convex Hull</h2>
<p>No area wasted, but takes much computations for constructing such trees.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1>Axis Aligned Bounding Box Tree</h1>
<h2>Intersecting an AABB</h2>
<p>for a ray $e+td$, it can intersect with the 4 lines as 
$$t_{xmin}=(x_{min} - x_e)/x_d, t_{xmax}=(x_{max} - x_e)/x_d$$
$$t_{ymin}=(y_{min} - y_e)/x_d, t_{ymax}=(y_{max} - y_e)/x_d$$
and an intersection happens if 
$$[t_{xmin}, t_{xmax}]\cap [t_{ymin}, t_{ymax}]\neq \emptyset\Rightarrow \exists t &gt; 0. e+td \in  [x_{min}, x_{max}]\times[y_{min}, y_{max}]$$</p>
<p>For the actual implementation, notice that if $d_x &lt; 0$, then $t_{xmin} &lt; t_{xmax}$ so that we need one if check.</p>
<p>Also, note that $d_x=0$ will lead to divide by 0 error and $t_{xmin}=t_{xmax} = \infty$, so we use $a_x = d_x^{-1}$ to handle such case so that for each coordinate we check</p>
<div class="highlight"><pre><span></span><span class="n">a</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">x_d</span>
<span class="k">if</span> <span class="n">a</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">t_xmin</span> <span class="o">=</span> <span class="n">a</span> <span class="o">*</span> <span class="p">(</span><span class="n">x_min</span> <span class="o">-</span> <span class="n">x_e</span><span class="p">)</span>
    <span class="n">t_xmax</span> <span class="o">=</span> <span class="n">a</span> <span class="o">*</span> <span class="p">(</span><span class="n">x_max</span> <span class="o">-</span> <span class="n">x_e</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">t_xmax</span> <span class="o">=</span> <span class="n">a</span> <span class="o">*</span> <span class="p">(</span><span class="n">x_min</span> <span class="o">-</span> <span class="n">x_e</span><span class="p">)</span>
    <span class="n">t_xmin</span> <span class="o">=</span> <span class="n">a</span> <span class="o">*</span> <span class="p">(</span><span class="n">x_max</span> <span class="o">-</span> <span class="n">x_e</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>

<div class=" highlight hl-ipython3"><pre><span></span><span class="n">abc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="o">.</span><span class="mi">4</span><span class="p">,</span> <span class="o">.</span><span class="mi">2</span><span class="p">])</span>
<span class="n">ghi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="o">.</span><span class="mi">5</span><span class="p">,</span> <span class="o">.</span><span class="mi">2</span><span class="p">])</span>
<span class="n">abc</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">abc</span><span class="p">,</span> <span class="n">ghi</span><span class="p">))</span>
</pre></div>


<div class="output_wrapper">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>0.0</pre>
</div>

</div>

</div>


<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="k">class</span> <span class="nc">Triangle</span><span class="p">(</span><span class="n">Object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">corners</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; corners is a 3 * 3 list of list </span>
<span class="sd">        each row is a corner</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">corners</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">corners</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">intersect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ray_d</span><span class="p">,</span> <span class="n">ray_e</span><span class="p">,</span> <span class="n">min_t</span><span class="p">,</span> <span class="n">max_t</span><span class="p">):</span>
        <span class="n">abc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">corners</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">corners</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">def_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">corners</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">corners</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">ghi</span> <span class="o">=</span> <span class="n">ray_d</span>
        <span class="n">jkl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">corners</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">ray_e</span>
        
        <span class="n">M</span> <span class="o">=</span> <span class="n">abc</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">def_</span><span class="p">,</span> <span class="n">ghi</span><span class="p">))</span>
        <span class="n">time</span> <span class="o">=</span> <span class="o">-</span> <span class="n">def_</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">abc</span><span class="p">,</span> <span class="n">jkl</span><span class="p">))</span> <span class="o">/</span> <span class="n">M</span>
        
        <span class="k">if</span> <span class="n">time</span> <span class="o">&lt;</span> <span class="n">min_t</span> <span class="ow">or</span> <span class="n">time</span> <span class="o">&gt;</span> <span class="n">max_t</span><span class="p">:</span>
            <span class="k">return</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
        <span class="n">gamma</span> <span class="o">=</span> <span class="n">ghi</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">abc</span><span class="p">,</span> <span class="n">jkl</span><span class="p">))</span> <span class="o">/</span> <span class="n">M</span>
        <span class="k">if</span> <span class="n">gamma</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">gamma</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
        <span class="n">beta</span> <span class="o">=</span> <span class="n">jkl</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">def_</span><span class="p">,</span> <span class="n">ghi</span><span class="p">))</span> <span class="o">/</span> <span class="n">M</span>
        <span class="k">if</span> <span class="n">beta</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">beta</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
        <span class="k">if</span> <span class="n">beta</span> <span class="o">+</span> <span class="n">gamma</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
        <span class="k">return</span> <span class="n">time</span>
    
    
<span class="k">class</span> <span class="nc">BoundingBox</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_corner</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_corner</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">min_corner</span><span class="p">,</span> <span class="n">max_corner</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_corner</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">min_corner</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_corner</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">max_corner</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">intersect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ray_d</span><span class="p">,</span> <span class="n">ray_e</span><span class="p">,</span> <span class="n">min_t</span><span class="p">,</span> <span class="n">max_t</span><span class="p">):</span>
        <span class="n">a</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">ray_d</span>
        <span class="n">diff_min</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_corner</span> <span class="o">-</span> <span class="n">ray_e</span>
        <span class="n">diff_max</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_corner</span> <span class="o">-</span> <span class="n">ray_e</span>
        <span class="n">t_xmin</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">diff_min</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">diff_max</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">t_xmax</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">diff_max</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">diff_min</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">t_ymin</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">diff_min</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">diff_max</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">t_ymax</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">diff_max</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">diff_min</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">t_zmin</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">diff_min</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">if</span> <span class="n">a</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">a</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">diff_max</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">t_zmax</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">diff_max</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">if</span> <span class="n">a</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">a</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">diff_min</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">t_xminn</span> <span class="o">&gt;</span> <span class="n">t_ymax</span> <span class="ow">or</span> <span class="n">t_ymin</span><span class="o">&gt;</span> <span class="n">t_xmax</span> \
            <span class="ow">or</span> <span class="n">t_xmin</span> <span class="o">&gt;</span> <span class="n">t_zmax</span> <span class="ow">or</span> <span class="n">t_zmin</span> <span class="o">&gt;</span> <span class="n">t_xmax</span> \
            <span class="ow">or</span> <span class="n">t_zmin</span> <span class="o">&gt;</span> <span class="n">t_ymax</span> <span class="ow">or</span> <span class="n">t_ymin</span> <span class="o">&gt;</span> <span class="n">t_zmax</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="n">t_max</span> <span class="o">&gt;</span> <span class="nb">max</span><span class="p">(</span><span class="n">t_xmax</span><span class="p">,</span> <span class="n">t_ymax</span><span class="p">,</span> <span class="n">t_zmax</span><span class="p">)</span> \ 
            <span class="ow">and</span> <span class="n">t_min</span> <span class="o">&lt;</span> <span class="nb">max</span><span class="p">(</span><span class="n">t_xmin</span><span class="p">,</span> <span class="n">t_ymin</span><span class="p">,</span> <span class="n">t_zmin</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">insert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">BoundingBox</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">min_corner</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">min_corner</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">min_corner</span><span class="p">)),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">max_corner</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">max_corner</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">max_corner</span><span class="p">)),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">Triangle</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">min_corner</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">min_corner</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:],</span> 
                                                     <span class="n">obj</span><span class="o">.</span><span class="n">corners</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
                                     <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">max_corner</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">max_corner</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:],</span> 
                                                     <span class="n">obj</span><span class="o">.</span><span class="n">corners</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
                                     <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            
    <span class="k">def</span> <span class="nf">center</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">min_corner</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_corner</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
</pre></div>


<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2>AABB Tree</h2>
<p>An AABB tree is constructed recursively, at each level, it is the bounding box that encloses all the item, and it further divide into subtrees, each subtree will have a smaller bounding box.</p>
<p>AABB tree will have bounding box overlapping.</p>

</div>
</div>
</div>

<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">AABBTree</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot; An AABB Tree</span>
<span class="sd">    box:   (BoundingBox) the bounding box that contains all the items</span>
<span class="sd">    left:  (AABBTree) the left subtree</span>
<span class="sd">    right: (AABBTree) the right subtree</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">box</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">left</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">right</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">objs</span><span class="p">):</span>
        
        <span class="c1"># base case, if this is the leaf node</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">objs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">box</span> <span class="o">=</span> <span class="n">obj</span>
            <span class="k">return</span>
        
        <span class="c1"># insert all objects into the top level bounding box</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">box</span> <span class="o">=</span> <span class="n">BoundingBox</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">objs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">box</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        
        <span class="c1"># determine the axis split</span>
        <span class="n">axis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">box</span><span class="o">.</span><span class="n">max_corner</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">box</span><span class="o">.</span><span class="n">min_corner</span><span class="p">)</span>
        <span class="n">left</span><span class="p">,</span> <span class="n">right</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">objs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">center</span><span class="p">()[</span><span class="n">axis</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">center</span><span class="p">()[</span><span class="n">axis</span><span class="p">]:</span>
                <span class="n">left</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">right</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        
        <span class="c1"># do a random split if all items are in one side</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">left</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">!=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">right</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">left</span><span class="p">,</span> <span class="n">right</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
            <span class="n">curr</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">objs</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">curr</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">left</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">right</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
                <span class="n">curr</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="c1"># recursively build the subtrees</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">left</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">left</span> <span class="o">=</span> <span class="n">AABBTree</span><span class="p">(</span><span class="n">left</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">right</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">right</span> <span class="o">=</span> <span class="n">AABBTree</span><span class="p">(</span><span class="n">right</span><span class="p">)</span>
            
    <span class="k">def</span> <span class="nf">intersect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ray_d</span><span class="p">,</span> <span class="n">ray_e</span><span class="p">,</span> <span class="n">min_t</span><span class="p">):</span>
        
        <span class="c1"># base case 1: if this is the leaf</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">box</span><span class="p">,</span> <span class="n">Triangle</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">box</span><span class="o">.</span><span class="n">intersect</span><span class="p">(</span><span class="n">ray_d</span><span class="p">,</span> <span class="n">ray_e</span><span class="p">,</span> <span class="n">min_t</span><span class="p">)</span>
        <span class="c1"># base case 2: if this is not the leaf</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">box</span><span class="p">,</span> <span class="n">BoundingBox</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">box</span><span class="o">.</span><span class="n">intersect</span><span class="p">(</span><span class="n">ray_d</span><span class="p">,</span> <span class="n">ray_e</span><span class="p">,</span> <span class="n">min_t</span><span class="p">):</span>
            <span class="k">return</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
        
        <span class="c1"># recursive call</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">left</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">t_left</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">left</span><span class="o">.</span><span class="n">intersect</span><span class="p">(</span><span class="n">ray_d</span><span class="p">,</span> <span class="n">ray_e</span><span class="p">,</span> <span class="n">min_t</span><span class="p">,</span> <span class="n">max_t</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">right</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">t_right</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">right</span><span class="o">.</span><span class="n">intersect</span><span class="p">(</span><span class="n">ray_d</span><span class="p">,</span> <span class="n">ray_e</span><span class="p">,</span> <span class="n">min_t</span><span class="p">,</span> <span class="n">max_t</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">t_left</span> <span class="o">&gt;</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span> <span class="ow">and</span> <span class="n">t_right</span> <span class="o">&gt;</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="n">t_left</span><span class="p">,</span> <span class="n">t_right</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="n">t_left</span><span class="p">,</span> <span class="n">t_right</span><span class="p">)</span>
</pre></div>


<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2>Distancing Using BFS</h2>
<p><a href="https://lihd1003.github.io/UofT-Course-Material-Repo/CSC265%20Enriched%20Data%20Structures%20and%20Analysis/NOTE/10.BFS_and_DFS.pdf">BFS Notes</a></p>

</div>
</div>
</div>

<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">Point</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">distance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">q</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">p</span> <span class="o">-</span> <span class="n">q</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
    
    
<span class="k">class</span> <span class="nc">PriorityQueue</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot; A poor priority queue implementation</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">items</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">priorities</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">def</span> <span class="nf">append</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">priority</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">priorities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">priority</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">dequeue</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">max_p</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">priorities</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">)):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">priorities</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">max_p</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">priorities</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        
<span class="k">def</span> <span class="nf">point_box_sqrd</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">box</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Measures the squared distance between</span>
<span class="sd">    a query point p and a bounding box</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">box</span><span class="o">.</span><span class="n">min_corner</span> <span class="o">-</span> <span class="n">q</span><span class="p">,</span> <span class="n">q</span> <span class="o">-</span> <span class="n">box</span><span class="o">.</span><span class="n">max_corner</span><span class="p">)),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">d</span> <span class="o">*</span> <span class="n">d</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">point_AABBTree_sqrd</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">root</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Measures the squared distance between</span>
<span class="sd">    a query point p and an AABBTree</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pq</span> <span class="o">=</span> <span class="n">PriorityQueue</span><span class="p">()</span>
    
    <span class="c1"># bfs</span>
    <span class="n">pq</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">point_box_sqrd</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">root</span><span class="o">.</span><span class="n">box</span><span class="p">),</span> <span class="n">root</span><span class="p">)</span>
    <span class="n">sqrd</span> <span class="o">=</span> <span class="n">max_sqrd</span> <span class="o">+</span> <span class="mi">1</span>
    
    <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">pq</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">curr_prio</span><span class="p">,</span> <span class="n">curr_item</span> <span class="o">=</span> <span class="n">pq</span><span class="o">.</span><span class="n">dequeue</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">curr_prio</span> <span class="o">&lt;</span> <span class="n">sqrd</span><span class="p">:</span>
            <span class="c1"># if is a leaf</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">curr_item</span><span class="o">.</span><span class="n">box</span><span class="p">,</span> <span class="n">Point</span><span class="p">):</span>
                <span class="n">new_sqrd</span> <span class="o">=</span> <span class="n">curr_item</span><span class="o">.</span><span class="n">box</span><span class="o">.</span><span class="n">distance</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
                <span class="n">sqrd</span> <span class="o">=</span> <span class="n">new_sqrd</span> <span class="k">if</span> <span class="n">new_sqrd</span> <span class="o">&lt;</span> <span class="n">sqrd</span> <span class="k">else</span> <span class="n">sqrd</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">curr_item</span><span class="o">.</span><span class="n">left</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">pq</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">point_box_sqrd</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">curr_item</span><span class="o">.</span><span class="n">left</span><span class="o">.</span><span class="n">box</span><span class="p">),</span> <span class="n">curr_item</span><span class="o">.</span><span class="n">left</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">curr_item</span><span class="o">.</span><span class="n">right</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">pq</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">point_box_sqrd</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">curr_item</span><span class="o">.</span><span class="n">right</span><span class="o">.</span><span class="n">box</span><span class="p">),</span> <span class="n">curr_item</span><span class="o">.</span><span class="n">right</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">sqrd</span>
</pre></div>


 

