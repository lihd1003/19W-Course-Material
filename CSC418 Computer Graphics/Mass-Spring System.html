<!DOCTYPE html>
<html>
<head><meta charset="utf-8" />

<title>Mass-Spring System - Notes Portal</title>

<link rel="icon" type="image/gif" href="https://lihd1003.github.io/assets/images/logo.png">
<link rel="stylesheet" href="https://lihd1003.github.io/assets/css/vendor.css" />
<link rel="stylesheet" href="https://lihd1003.github.io/assets/css/style.css" />
<link href="https://fonts.googleapis.com/css?family=Roboto&display=swap" rel="stylesheet">
<script src="https://kit.fontawesome.com/98fa07784c.js"></script>



<style type="text/css">
/* Overrides of notebook CSS for static HTML export */

div#notebook {
  overflow: visible;
  border-top: none;
}@media print {
  div.cell {
    display: block;
    page-break-inside: avoid;
  } 
  div.output_wrapper { 
    display: block;
    page-break-inside: avoid; 
  }
  div.output { 
    display: block;
    page-break-inside: avoid; 
  }
}
</style>

<!-- Custom stylesheet, it must be in the same directory as the html file -->
<link rel="stylesheet" href="https://lihd1003.github.io/UofT-Course-Material-Repo/index/custom.css">

<!-- Loading mathjax macro -->
<!-- Load mathjax -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS_HTML"></script>
    <!-- MathJax configuration -->
    <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ['$','$'], ["\\(","\\)"] ],
            displayMath: [ ['$$','$$'], ["\\[","\\]"] ],
            processEscapes: true,
            processEnvironments: true
        },
        // Center justify equations in code and markdown cells. Elsewhere
        // we use CSS to left justify single line equations in code cells.
        displayAlign: 'center',
        "HTML-CSS": {
            styles: {'.MathJax_Display': {"margin": 0}},
            linebreaks: { automatic: true }
        }
    });
    </script>
    <!-- End of mathjax configuration --></head>
<body>
	<!-- header -->
   <header class="header-sticky header-dark">
    <div class="container">
      <nav class="navbar navbar-expand-lg navbar-dark">
        <a class="navbar-brand" href="./index.html">
          <img class="navbar-logo navbar-logo-light" src="https://lihd1003.github.io/assets/images/logo.png" alt="Logo">
          <img class="navbar-logo navbar-logo-dark" src="https://lihd1003.github.io/assets/images/logo.png" alt="Logo">
        </a>

        <div class="collapse navbar-collapse" id="navbarSupportedContent">
          <ul class="navbar-nav align-items-center mr-auto">
          </ul>

          <ul class="navbar-nav align-items-center mr-0">
            <li class="nav-item">
              <a href="https://github.com/lihd1003" class="nav-link waves-effect waves-light" target="_blank">
                <i class="icon-github mr-2"></i>GitHub
              </a>
            </li>
            <li class="nav-item">
              <a href="https://github.com/lihd1003/UofT-Course-Material-Repo" class="nav-link waves-effect waves-light" target="_blank">
                <i class="icon-star mr-2"></i>Star the Repo
              </a>
            </li>
          </ul>
        </div>
      </nav>
    </div>
  </header>

<section class="hero hero-with-header text-white" data-top-top="transform: translateY(0px);" data-top-bottom="transform: translateY(250px);">
    <div class="image image-overlay" style="background-image:url(https://lihd1003.github.io/assets/images/black.jpg)"></div>
    <div class="container">
      <div class="row align-items-center">
        <div class="col text-shadow">

          <h1 class="mb-0">Mass-Spring System</h1>
        </div>
      </div>
    </div>
 </section>
 <section class="bg-white sec" id="project">
  <div tabindex="-1" id="notebook" class="border-box-sizing">
    <div class="container" id="notebook-container">

<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Mass-and-Spring">Mass and Spring<a class="anchor-link" href="#Mass-and-Spring">&#182;</a></h1><p>We model the physical behavior of the system as a network of point masses $P = \{(p_1, m_1),...,(p_n, m_n)\}$, where $p_1\in\mathbb R^3$ is the position and $m_i$ is the mass, and springs $E = \{(p_i, p_j)\mid 1\leq i\neq j \leq n\}$, so that the shape is a graph $G = (P, E)$.</p>
<h2 id="Goal">Goal<a class="anchor-link" href="#Goal">&#182;</a></h2><p>Following Newton's second law, $f = ma$ where $f,a\in\mathbb R^3$. For each point mass, we need to have 
$$f_{i} = T_{i} + f^{ext}$$ where<br>
$T_{i} = \sum_{j, (p_i, p_j)\in E}f^{elastic}(p_i, p_j)$ is the sum of forces coming from any incident spring<br>
$f^{ext}$ is the external forces applied on the point mass</p>
<h2 id="Spring-Potential-Energy-$V(p_i,-p_j)$">Spring Potential Energy $V(p_i, p_j)$<a class="anchor-link" href="#Spring-Potential-Energy-$V(p_i,-p_j)$">&#182;</a></h2><p>For each spring $(p_i, p_j)$, define its stiffness $k &gt; 0$ (assuming all springs have the same stiffness for now) and rest length $r_{i,j}\in\mathbb R$. The <strong>potential energy</strong> $V(p_i, p_j)$ is defined as 
$$V(p_i, p_j):\mathbb R^{3\times 2}\rightarrow \mathbb R:= \frac k2(\|p_i-p_j\|-r_{ij})^2$$
Note that $\frac12$ is because the force is attached with two vertices, hence we only calculate half on each vertex.</p>
<p>The force exerted by the spring on each mass is the partial derivative of the potential energy $V$ with respect to the corresponding mass position. For example, for $p_i$ we have 
$$f_{ij} = - \frac{\partial V}{\partial p_i}\in\mathbb R^3$$</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Acceleration-of-the-point-mass-$a_i^t$">Acceleration of the point mass $a_i^t$<a class="anchor-link" href="#Acceleration-of-the-point-mass-$a_i^t$">&#182;</a></h2><p>Define $p_i^t = p_i(t):\mathbb R^{\geq 0}\rightarrow \mathbb R^3$ be the position for mass $i$ at time $t$, and velocities ${p'}_i^t = \frac{\partial p_i}{\partial t}(t)\in\mathbb R^3$.<br>
Given $p_i^0$ and ${p'}_i^0$, which is the initial conditions of the simulation system. Also, note that $p_i^t$ is determined only on the last know value and won't trace back, i.e. given any $t\geq 0$, we can still treat these values as the initial conditions for the remaining time.</p>
<p>For the purpose of the simulation, we only need to know the position of each mass at discrete time, so we can use discrete approximation. Therefore, ${p'}_i^t$ can be approximated by finite difference 
$${p'}_i^t = \frac{p_i^t - p_i^{t-\Delta t}}{\Delta t}$$
Then, we use central finite difference to approximate the acceleration at time $t$
\begin{align*}
a_i^t = {p''}_i^t &amp;= \frac{{p'}_i^{t+\Delta t} - {p'}_i^{t}}{\Delta t}\\
&amp;= \frac{1}{\Delta t}\big(\frac{p_i^{t+\Delta t} - p_i^t}{\Delta t} - \frac{p_i^{t} - p_i^{t-\Delta t}}{\Delta t}\big)\\
&amp;= \frac{p^{t+\Delta t} - 2p_i^{t} + p^{t-\Delta t}}{(\Delta t)^2}
\end{align*}</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Time-integration">Time integration<a class="anchor-link" href="#Time-integration">&#182;</a></h2><p>Coming back to the goal, since each point mass should follow Newton's second law, we can sum them together and integrate only $p$, i.e. 
\begin{align*}
V(P) &amp;= \frac12\sum_{i,j}k(\|p_i - p_j\|-r_{ij})^2\\
T(P) &amp;= (\Delta t)^2 \bigg\{\sum_i m_i \big(\frac{p_i - 2p_i^t + p_i^{t-\Delta t}}{(\Delta t)^2}\big)^2\bigg\}\\
F^{ext}(P) &amp;= \sum_i p_i^Tf_i^{ext}\\
P &amp;= (p_1,..., p_n)\in\mathbb R^{3\times n}
\end{align*}
We want $$V - F^{ext} = T$$
Therefore, we can view the problem as a optimization problem, i.e. 
$$p^{t+\Delta t} = \arg\min_{P} V(P)-T(P)-F^{ext}(P)$$</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Fast-Simulation-of-Mass-Spring-System"><a href="http://graphics.berkeley.edu/papers/Liu-FSM-2013-11/Liu-FSM-2013-11.pdf">Fast Simulation of Mass-Spring System</a><a class="anchor-link" href="#Fast-Simulation-of-Mass-Spring-System">&#182;</a></h1><p>Observe that the non linear energy  can be written as a small optimization problem
$$(\|p_i-p_j\|-r_{ij})^2 = \min_{d_{ij}\in\mathbb R^3, \|d_{ij}\|=r_{ij}}\|(p_i - p_j) - d_{ij}\|^2$$
Therefore, suppose we know the vector $d_{ij}$ corresponds to the unknown optimal solution $p^{t+\Delta t}$, then treating $d_{ij}$ as constant, we cound find the optimal solution by 
\begin{align*}
p^{t+\Delta t} &amp;= \arg\min_p \hat E(p)\\
\hat E(P) &amp;=\big(\frac12\sum_{ij}k\|(p_i-p_j)-d_{ij}\|^2\big) - \Delta t^2\\
&amp;\quad - (\Delta t)^2 \bigg\{\sum_i m_i \big(\frac{p_i - 2p_i^t + p_i^{t-\Delta t}}{(\Delta t)^2}\big)^2\bigg\}\\
&amp;\quad -\sum_i p_i^Tf_i^{ext}
\end{align*}
Which is quadratic w.r.t. $P$ and we can have the solution at 
$$d_P \hat E = 0$$</p>
<p>Therefore, we can define a local-global iterative algorithm.</p>
<p>while condition not satisfied:</p>
<ul>
<li>Given current $P$, determine $d_{ij}$ from the small optimization problem</li>
<li>Find $P$ that minimizes $\hat E$</li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Matrices">Matrices<a class="anchor-link" href="#Matrices">&#182;</a></h2><p>To allow parallel computation, we need to write the equations into matrix form.</p>
<p>Define $P = [p_1,...,p_n]\in \mathbb R^{n\times 3}$, and similarly $P^t, P^{t-\Delta t} \in \mathbb R^{n\times 3}$, let $M = diag(m_1,...,m_n)\in \mathbb R^{n\times n}$, we have 
\begin{align*}
T(P) &amp;= (\Delta t)^2 \bigg\{\sum_i m_i \big(\frac{p_i - 2p_i^t + p_i^{t-\Delta t}}{(\Delta t)^2}\big)^2\bigg\}\\
&amp;= \frac1{\Delta t^2}\bigg\{(p_i - 2p_i^t + p_i^{t-\Delta t})^Tm_i(p_i - 2p_i^t + p_i^{t-\Delta t})\bigg\}\\
&amp;= \frac1{\Delta t^2}tr(P-2P^t + P^{t-\Delta t})^TM(P-2P^t + P^{t-\Delta t})
\end{align*}</p>
<p>Define $A\in\mathbb \{-1, 0, 1\}^{|E|\times |V|}$ be the matrix that represents the edges, where each row $e$ represents one edge $e = (i, j)$ as
$$A_{ek} = \begin{cases}1&amp;k=i\\-1&amp;k=j\\0&amp;\text{otherwise}\end{cases}$$
Let $d = \begin{bmatrix}d_{e_1}\\...\\d_{e_m}\end{bmatrix}\in\mathbb R^{\|E\|\times 3}$ being $d_{ij}$'s stacked vertically, so that 
$$\hat V(P) = \sum_{ij}\frac{k}2 \|(p_i - p_j) -d_{ij}\|^2 = \frac{k}2\big[(AP-d)^T(AP-d)\big]$$</p>
<p>Finally, let $f^{ext} =\begin{bmatrix}f_1^{ext}\\...\\f_n^{ext}\end{bmatrix}$ so that 
$$F(P) = tr(P^Tf^{ext})$$
and we can combine the equations together and write it into quadratic form, with some computation, we can have 
\begin{align*}
Q &amp;= kA^TA + \frac1{\Delta t^2}M\\
b&amp;= kA^Td + \frac{1}{\Delta t^2}M(2P^t - P^{t-\Delta t})\\
P^{t+\Delta t} &amp;= \arg\min_p \frac12 tr(P^TQP) - tr(P^Tb)
\end{align*}
Note this is the quadratic formula and 
$$\nabla \hat E(p) = QP - b = 0$$
solve to have $P = Q^{-1}b$
Note that $Q$ involves only $A, M, k, \Delta t$, which are all constantly defined, hence it can be precomputed and factorized into $Q = LL^T$, which $L$ is triangular, hence solve $QP = b$ ($O(n^3)$ ops) becomes solve $LL^TP = b$ ($O(n^2)$ ops)</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Sparse-Matrices">Sparse Matrices<a class="anchor-link" href="#Sparse-Matrices">&#182;</a></h2><p>Note that in most cases, $A, M$ are quite sparse, where $\frac{2}{n}$ of $A$ and $\frac1n$ of $M$ are non-zero. Instead of storing the matrix as $O(n^2)$ entries, using a sparse matrix, where takes only <code>n * (int, int, float)</code> space. Also, operations on sparse matrix are fewer $O(n^{\approx 1.5})$ for precompute $Q$ and $O(n)$ for substitution.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Pinned-Vertices">Pinned Vertices<a class="anchor-link" href="#Pinned-Vertices">&#182;</a></h2><p>Note that if we simulate gravity $g$ within $f^{ext}$, all the mass point will be pulled down quickly, therefore, we need to fix some mass point as pinned vertices, i.e. $p_k = p_k^{rest}, \forall k$ is pinned.<br>
To implement this equality constraint, we use penalty method, i.e. add an extremely large penalty onto the pinned vertices, 
$$\frac w2 \sum_{k} \|p_k - p_k^{rest}\|^2$$
when $p_k$ moves away from $p^{rest}$, the potential energy is much larger than the energy in the system, hence $p_k$ will be forced to be $p_k^{rest}$.</p>
<p>Therefore, we can have $C\in \mathbb R^{|pinned|\times n}, C_{ki} = \mathbb I(p_i\text{ is the kth pinned vertex})$
and the penalty term becomes 
$$\frac w2 tr((CP-CP^{rest})^T(CP-CP^{rest}))$$, so that we have 
$$Q_{C} = wC^TC, b_C = wC^TCP^{rest}$$
And we need to solve $(Q+Q_C)P = (b+b_C)$
Note that $Q+Q_C$ is still constant, hence prefactorization still works.</p>

</div>
</div>
</div>
    </div>
  </div>
</section>
  <script src="https://lihd1003.github.io/assets/js/vendor.js"></script>
  <script src="https://lihd1003.github.io/assets/js/app.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
  <script>
    $("table").addClass("table table-lined")
  </script>
</body>

 


</html>
